<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>upload service</title>
</head>

<body>
    <h1>File Upload</h1>
    <input type="file" id="inputFile">
    <button type="submit" id="btnUpload">upload</button>
    <p id="progress"></p>
</body>

<script>
    const fileInput = document.getElementById("inputFile");
    const uploadBtn = document.getElementById("btnUpload");
    const progress = document.getElementById("progress");

    uploadBtn.addEventListener("click", () => {
        const reader = new FileReader();
        const file = fileInput.files[0];
        reader.onload = async (ev) => {
            const CHUNK_SIZE = 64 * 1024; // 64 KB
            // +1 for any remaining chunk with size < CHUNK_SIZE
            const CHUNK_COUNT = Math.floor(ev.target.result.byteLength / CHUNK_SIZE) + 1;

            fileName = `${Math.round(Math.random() * 1000000, 0)}-${file.name}`;

            for (let id = 0; id < CHUNK_COUNT; id++) {
                let start = id * CHUNK_SIZE;
                let end = start + CHUNK_SIZE;
                const chunkToSend = ev.target.result.slice(start, end);
                // console.log(chunkToSend.byteLength)
                try {
                    await fetch("http://localhost:8080/upload", {
                        method: "POST",
                        headers: {
                            "content-type": "application/octet-stream",
                            "file-name": encodeURIComponent(fileName), // for non-ascii strings like Arablic
                        },
                        body: chunkToSend,
                    });
                    // console.log(CHUNK_COUNT, id);
                    let done = Math.round((id + 1) / CHUNK_COUNT * 100, 0);
                    progress.textContent = `Uploaded: ${done}/100%`;
                } catch (e) {
                    console.error("error fething:", e);
                }
            }
        };
        reader.readAsArrayBuffer(file);
    });
</script>

</html>
